<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Статистика переходов</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f4f4f9; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px 30px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; }
        #stats-container { min-height: 100px; }
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-box { background-color: #f0f8ff; padding: 20px; text-align: center; border-radius: 8px; }
        .stat-box .number { font-size: 2.5em; font-weight: bold; color: #0056b3; }
        .stat-box .label { font-size: 1em; color: #666; margin-top: 5px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Статистика переходов</h1>
        <div id="stats-container"><p>Загрузка данных...</p></div>
    </div>

    <script>
        const ntfyTopic = 'my_super_secret_stats_log_ab11';

        async function loadStats() {
            const statsContainer = document.getElementById('stats-container');
            try {
                const response = await fetch(`https://ntfy.sh/${ntfyTopic}/json?poll=1`);
                if (!response.ok) {
                    throw new Error(`Сетевая ошибка: ${response.statusText}`);
                }

                const textData = await response.text();

                const data = textData.trim().split('\n').map(line => {
                    try {
                        return JSON.parse(line);
                    } catch (e) {
                        return null;
                    }
                }).filter(item => item !== null); 

                if (!data || data.length === 0) {
                    statsContainer.innerHTML = '<p>Данных пока нет.</p>';
                    return;
                }

                const totalRedirects = data.length;
                const countryCounts = {};
                const ipCounts = {};
                
                data.forEach(event => {
                    if (!event.message) return;

                    const ipMatch = event.message.match(/IP: ([\d\.]+|Unknown)/);
                    if (ipMatch && ipMatch[1]) {
                        const ip = ipMatch[1];
                        ipCounts[ip] = (ipCounts[ip] || 0) + 1;
                    }

                    const countryMatch = event.message.match(/Country: ([\w\s]+|Unknown)/);
                    if (countryMatch && countryMatch[1]) {
                        const country = countryMatch[1];
                        countryCounts[country] = (countryCounts[country] || 0) + 1;
                    }
                });

                const uniqueIps = Object.keys(ipCounts).length;
                const sortedCountries = Object.entries(countryCounts).sort(([,a],[,b]) => b-a);

                let html = `
                    <div class="stat-grid">
                        <div class="stat-box">
                            <div class="number">${totalRedirects}</div>
                            <div class="label">Всего переходов</div>
                        </div>
                        <div class="stat-box">
                            <div class="number">${uniqueIps}</div>
                            <div class="label">Уникальных IP</div>
                        </div>
                    </div>
                    <h2>Переходы по странам</h2>
                    <table>
                        <thead><tr><th>Страна</th><th>Количество</th></tr></thead>
                        <tbody>
                            ${sortedCountries.map(([country, count]) => `<tr><td>${country}</td><td>${count}</td></tr>`).join('')}
                        </tbody>
                    </table>
                `;
                statsContainer.innerHTML = html;

            } catch (error) {
                console.error("Ошибка при загрузке статистики:", error);
                statsContainer.innerHTML = `<p style="color: red;">Ошибка загрузки статистики: ${error.message}</p>`;
            }
        }

        loadStats();
    </script>
</body>
</html>